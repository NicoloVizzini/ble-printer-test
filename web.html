<!DOCTYPE html>
<html>
<head>
<title>Universal BLE Thermal Printer</title>
<style>
body {
    font-family: Arial, sans-serif;
    max-width: 800px;
    margin: 20px auto;
    padding: 20px;
}
button {
    background: #007bff;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin: 10px 5px;
}
button:hover { background: #0056b3; }
button:disabled { background: #ccc; cursor: not-allowed; }
.device-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    background: #f9f9f9;
}
.device-card.selected {
    border-color: #007bff;
    background: #e7f3ff;
}
.device-name { font-weight: bold; font-size: 16px; }
.device-id { color: #666; font-size: 12px; font-family: monospace; }
.service-list { margin: 10px 0; }
.service { 
    background: #fff; 
    padding: 8px; 
    margin: 5px 0; 
    border-radius: 4px;
    border-left: 3px solid #007bff;
}
.characteristic { 
    background: #f0f8ff; 
    padding: 5px 10px; 
    margin: 3px 0; 
    border-radius: 3px;
    font-size: 12px;
    font-family: monospace;
}
#status {
    margin: 20px 0;
    padding: 10px;
    border-radius: 5px;
    display: none;
}
.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
textarea {
    width: 100%;
    height: 80px;
    margin: 10px 0;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-family: monospace;
}
.section {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
    background: #fafafa;
}
.section h3 { margin-top: 0; }
</style>
</head>
<body>
<h1>Universal BLE Thermal Printer Scanner</h1>

<div class="section">
    <h3>Step 1: Scan for BLE Devices</h3>
    <button id="scanAll">Scan All BLE Devices</button>
    <button id="scanPrinters">Scan Likely Printers Only</button>
    <div id="status"></div>
</div>

<div id="deviceList" class="section" style="display: none;">
    <h3>Step 2: Select Your Printer</h3>
    <div id="devices"></div>
</div>

<div id="serviceExplorer" class="section" style="display: none;">
    <h3>Step 3: Explore Services & Characteristics</h3>
    <div id="services"></div>
    <button id="testSelected" disabled>Test Selected Characteristic</button>
</div>

<div id="printSection" class="section" style="display: none;">
    <h3>Step 4: Print</h3>
    <textarea id="customText" placeholder="Enter text to print...">Hello from Universal BLE Printer!</textarea>
    <div>
        <button id="printSimple">Print as Plain Text</button>
        <button id="printFormatted">Print with ESC/POS Commands</button>
        <button id="disconnect">Disconnect</button>
    </div>
</div>

<script>
let selectedDevice = null;
let selectedService = null;
let selectedCharacteristic = null;
let connectedServer = null;

// Common thermal printer service UUIDs
const COMMON_PRINTER_SERVICES = [
    'e7810a71-73ae-499d-8c15-faa9aef0c3f2', // Your printer's service
    '000018f0-0000-1000-8000-00805f9b34fb', // Common thermal printer service
    '49535343-fe7d-4ae5-8fa9-9fafd205e455', // Another common one
    '6e400001-b5a3-f393-e0a9-e50e24dcca9e', // Nordic UART Service
];

// ESC/POS commands
const ESC = 0x1B;
const commands = {
    INIT: [ESC, 0x40],
    FEED_LINE: [0x0A],
    CUT_PAPER: [0x1D, 0x56, 0x00],
};

function showStatus(message, type = 'info') {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = type;
    statusDiv.style.display = 'block';
    console.log(`[${type.toUpperCase()}] ${message}`);
}

async function scanAllDevices() {
    try {
        showStatus('Scanning for all BLE devices...', 'info');
        
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: COMMON_PRINTER_SERVICES
        });
        
        await exploreDevice(device);
        
    } catch (error) {
        showStatus(`Scan failed: ${error.message}`, 'error');
    }
}

async function scanPrinters() {
    try {
        showStatus('Scanning for likely printers...', 'info');
        
        const device = await navigator.bluetooth.requestDevice({
            filters: [
                { namePrefix: 'Printer' },
                { namePrefix: 'MTP-' },
                { namePrefix: 'POS-' },
                { namePrefix: 'Thermal' },
                { namePrefix: 'BT-' },
                { namePrefix: 'PTP-' },
                { namePrefix: 'RPP' },
                { services: COMMON_PRINTER_SERVICES }
            ],
            optionalServices: COMMON_PRINTER_SERVICES
        });
        
        await exploreDevice(device);
        
    } catch (error) {
        showStatus(`Scan failed: ${error.message}`, 'error');
    }
}

async function exploreDevice(device) {
    try {
        selectedDevice = device;
        showStatus(`Connecting to ${device.name || 'Unknown Device'}...`, 'info');
        
        connectedServer = await device.gatt.connect();
        showStatus(`Connected! Discovering services...`, 'info');
        
        const services = await connectedServer.getPrimaryServices();
        
        displayDevice(device, services);
        
    } catch (error) {
        showStatus(`Device exploration failed: ${error.message}`, 'error');
    }
}

async function displayDevice(device, services) {
    const deviceDiv = document.getElementById('devices');
    const servicesDiv = document.getElementById('services');
    
    // Display device info
    deviceDiv.innerHTML = `
        <div class="device-card selected">
            <div class="device-name">${device.name || 'Unknown Device'}</div>
            <div class="device-id">ID: ${device.id}</div>
            <div>GATT Connected: ${device.gatt.connected ? 'Yes' : 'No'}</div>
        </div>
    `;
    
    // Display services and characteristics
    let servicesHtml = '';
    
    for (const service of services) {
        const serviceId = service.uuid;
        const serviceName = getServiceName(serviceId);
        
        try {
            const characteristics = await service.getCharacteristics();
            
            servicesHtml += `
                <div class="service">
                    <strong>${serviceName}</strong><br>
                    <small>UUID: ${serviceId}</small>
                    <div class="characteristics">
            `;
            
            for (const char of characteristics) {
                const charId = char.uuid;
                const properties = [];
                if (char.properties.read) properties.push('read');
                if (char.properties.write) properties.push('write');
                if (char.properties.writeWithoutResponse) properties.push('writeWithoutResponse');
                if (char.properties.notify) properties.push('notify');
                
                const canWrite = char.properties.write || char.properties.writeWithoutResponse;
                const bgColor = canWrite ? '#e8f5e8' : '#f0f8ff';
                
                servicesHtml += `
                    <div class="characteristic" style="background: ${bgColor};" 
                         onclick="selectCharacteristic('${serviceId}', '${charId}', ${canWrite})"
                         style="cursor: pointer;">
                        <strong>Characteristic:</strong> ${charId}<br>
                        <strong>Properties:</strong> ${properties.join(', ')}
                        ${canWrite ? '<br><em>‚Üê Click to select for printing</em>' : ''}
                    </div>
                `;
            }
            
            servicesHtml += '</div></div>';
            
        } catch (error) {
            servicesHtml += `
                <div class="service">
                    <strong>${serviceName}</strong><br>
                    <small>UUID: ${serviceId}</small><br>
                    <em>Could not read characteristics: ${error.message}</em>
                </div>
            `;
        }
    }
    
    servicesDiv.innerHTML = servicesHtml;
    
    document.getElementById('deviceList').style.display = 'block';
    document.getElementById('serviceExplorer').style.display = 'block';
    
    showStatus('Device explored! Click on a writable characteristic to select it for printing.', 'success');
}

function getServiceName(uuid) {
    const knownServices = {
        'e7810a71-73ae-499d-8c15-faa9aef0c3f2': 'Custom Printer Service',
        '000018f0-0000-1000-8000-00805f9b34fb': 'Generic Printer Service',
        '49535343-fe7d-4ae5-8fa9-9fafd205e455': 'Microchip Data Service',
        '6e400001-b5a3-f393-e0a9-e50e24dcca9e': 'Nordic UART Service',
        '0000180f-0000-1000-8000-00805f9b34fb': 'Battery Service',
        '0000180a-0000-1000-8000-00805f9b34fb': 'Device Information Service',
    };
    
    return knownServices[uuid] || `Unknown Service (${uuid.substring(0, 8)}...)`;
}

async function selectCharacteristic(serviceUuid, charUuid, canWrite) {
    if (!canWrite) {
        showStatus('This characteristic is not writable!', 'warning');
        return;
    }
    
    try {
        const service = await connectedServer.getPrimaryService(serviceUuid);
        const characteristic = await service.getCharacteristic(charUuid);
        
        selectedService = service;
        selectedCharacteristic = characteristic;
        
        // Highlight selected characteristic
        document.querySelectorAll('.characteristic').forEach(el => {
            el.style.border = 'none';
        });
        event.target.style.border = '2px solid #007bff';
        
        document.getElementById('testSelected').disabled = false;
        document.getElementById('printSection').style.display = 'block';
        
        showStatus(`Selected characteristic: ${charUuid}`, 'success');
        
    } catch (error) {
        showStatus(`Failed to select characteristic: ${error.message}`, 'error');
    }
}

async function testSelected() {
    if (!selectedCharacteristic) {
        showStatus('No characteristic selected!', 'error');
        return;
    }
    
    try {
        showStatus('Testing characteristic with simple message...', 'info');
        
        const encoder = new TextEncoder();
        const testMessage = encoder.encode('TEST\n');
        
        await selectedCharacteristic.writeValue(testMessage);
        
        showStatus('Test message sent successfully! Check if anything printed.', 'success');
        
    } catch (error) {
        showStatus(`Test failed: ${error.message}`, 'error');
    }
}

async function printSimple() {
    if (!selectedCharacteristic) {
        showStatus('No characteristic selected!', 'error');
        return;
    }
    
    try {
        const text = document.getElementById('customText').value;
        showStatus('Printing as plain text...', 'info');
        
        const encoder = new TextEncoder();
        const data = encoder.encode(text + '\n\n\n');
        
        await selectedCharacteristic.writeValue(data);
        
        showStatus('Plain text sent to printer!', 'success');
        
    } catch (error) {
        showStatus(`Print failed: ${error.message}`, 'error');
    }
}

async function printFormatted() {
    if (!selectedCharacteristic) {
        showStatus('No characteristic selected!', 'error');
        return;
    }
    
    try {
        const text = document.getElementById('customText').value;
        showStatus('Printing with ESC/POS commands...', 'info');
        
        // Send initialization
        await selectedCharacteristic.writeValue(new Uint8Array(commands.INIT));
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Send text
        const encoder = new TextEncoder();
        const textData = encoder.encode(text);
        await selectedCharacteristic.writeValue(textData);
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Send line feeds
        await selectedCharacteristic.writeValue(new Uint8Array(commands.FEED_LINE));
        await selectedCharacteristic.writeValue(new Uint8Array(commands.FEED_LINE));
        await selectedCharacteristic.writeValue(new Uint8Array(commands.FEED_LINE));
        
        showStatus('Formatted text sent to printer!', 'success');
        
    } catch (error) {
        showStatus(`Formatted print failed: ${error.message}`, 'error');
    }
}

async function disconnect() {
    try {
        if (connectedServer) {
            await connectedServer.disconnect();
        }
        selectedDevice = null;
        selectedService = null;
        selectedCharacteristic = null;
        connectedServer = null;
        
        // Reset UI
        document.getElementById('deviceList').style.display = 'none';
        document.getElementById('serviceExplorer').style.display = 'none';
        document.getElementById('printSection').style.display = 'none';
        document.getElementById('testSelected').disabled = true;
        
        showStatus('Disconnected successfully', 'info');
        
    } catch (error) {
        showStatus(`Disconnect error: ${error.message}`, 'error');
    }
}

// Event listeners
document.getElementById('scanAll').addEventListener('click', scanAllDevices);
document.getElementById('scanPrinters').addEventListener('click', scanPrinters);
document.getElementById('testSelected').addEventListener('click', testSelected);
document.getElementById('printSimple').addEventListener('click', printSimple);
document.getElementById('printFormatted').addEventListener('click', printFormatted);
document.getElementById('disconnect').addEventListener('click', disconnect);

// Check Web Bluetooth support
if (!navigator.bluetooth) {
    showStatus('Web Bluetooth is not supported in this browser', 'error');
    document.getElementById('scanAll').disabled = true;
    document.getElementById('scanPrinters').disabled = true;
}
</script>
</body>
</html>
